var filesUrl="https://www.googleapis.com/drive/v2/files",filesUploadUrl="https://www.googleapis.com/upload/drive/v2/files",bgPage=chrome.extension.getBackgroundPage();function stringify(a){var b,d=[];for(b in a)d.push(encodeURIComponent(b)+"="+encodeURIComponent(a[b]));return d.join("&")}
function sendRequest(a,b,d){b=b?b:filesUrl;b=a.parameters?b+"?"+stringify(a.parameters):b;var c=new XMLHttpRequest;c.open(a.method,b,!1);c.addEventListener("readystatechange",function(f){4===c.readyState&&d(c)});for(var e in a.headers)a.headers.hasOwnProperty(e)&&c.setRequestHeader(e,a.headers[e]);bgPage.oauth.getAuthorizationHeader(function(f){c.setRequestHeader("Authorization",f);c.send(a.body)})}var GoogleFile=function(a,b){this.src=a;this.setSource=b};
GoogleFile.prototype.set=function(a){this.src=JSON.stringify(a);this.setSource(this.src)};GoogleFile.prototype.get=function(a){var b=this.src?JSON.parse(this.src):{};return a?b[a]:b};GoogleFile.prototype.update=function(a){a=JSON.parse(a);"drive#file"===a.kind&&this.set(a)};GoogleFile.prototype.getLastUpdateTime=function(){return Date.parse(this.get("modifiedDate"))};
GoogleFile.prototype.createNewFile=function(a){if(!a)throw"File name is not defined";a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:a,mimeType:"text/plain"})};var b=this;sendRequest(a,null,function(d){if(200!==d.status)throw"There was a problem in setting up the sync. Last request status: "+d.status+"\n"+d.responseText;b.update(d.responseText)})};
GoogleFile.prototype.searchFileByName=function(a,b){if(!a)throw"File name is not defined";var d=this;sendRequest({method:"GET",parameters:{q:"title='"+a+"' and trashed = false"}},null,function(c){if(200!==c.status)throw"There was a problem in searching for the doc - "+a+".Last request status: "+c.status+"\n"+c.responseText;c=JSON.parse(c.responseText);c.hasOwnProperty("items")&&c.items instanceof Array&&0<c.items.length&&d.set(c.items[0]);b&&b()})};
GoogleFile.prototype.refreshLocalMetadata=function(a){var b=this;sendRequest({method:"GET"},this.get("selfLink"),function(d){if(200!==d.status)throw"There was a problem in refreshing the doc entry. Last request status: "+d.status+"\n"+d.responseText;b.update(d.responseText);a(b)})};
GoogleFile.prototype.getData=function(a){sendRequest({method:"GET"},this.get("downloadUrl"),function(b){if(200!==b.status)throw"There was a problem downloading the doc. Last request status: "+b.status+"\n"+b.responseText;a(b.responseText)})};
GoogleFile.prototype.setData=function(a){a={method:"PUT",headers:{"Content-Type":"text/plain"},parameters:{uploadType:"media"},body:a||""};var b=filesUploadUrl+"/"+this.get("id"),d=this;sendRequest(a,b,function(c){if(200!==c.status)throw"There was a problem in updating the doc. Last request status: "+c.status+"\n"+c.responseText;d.update(c.responseText)})};
