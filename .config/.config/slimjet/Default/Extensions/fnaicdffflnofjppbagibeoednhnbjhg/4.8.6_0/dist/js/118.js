"use strict";(self.webpackChunkfloccus=self.webpackChunkfloccus||[]).push([[118],{49118:(t,a,e)=>{e.r(a),e.d(a,{actions:()=>w,default:()=>r,mutations:()=>c});var s=e(20144),n=e(54526),o=e(77968),i=e.n(o);const c={LOADING_START:"LOADING_START",LOADING_END:"LOADING_END",SET_LOCKED:"SET_LOCKED",SET_SECURED:"SET_SECURED",LOAD_ACCOUNTS:"LOAD_ACCOUNTS",STORE_ACCOUNT_DATA:"STORE_ACCOUNT_DATA",REMOVE_ACCOUNT:"REMOVE_ACCOUNT",SET_LOGIN_FLOW_STATE:"SET_LOGIN_FLOW_STATE"},O={[c.SET_LOCKED](t,a){t.locked=a},[c.SET_SECURED](t,a){t.secured=a},[c.LOAD_ACCOUNTS](t,a){t.accounts=a},[c.STORE_ACCOUNT_DATA](t,a){let{id:e,data:n}=a;s.Z.set(t.accounts[e],"data",n)},[c.REMOVE_ACCOUNT](t,a){s.Z.delete(t.accounts,a)},[c.SET_LOGIN_FLOW_STATE](t,a){s.Z.set(t.loginFlow,"isRunning",a)},[c.LOADING_START](t,a){s.Z.set(t.loading,a,!0)},[c.LOADING_END](t,a){s.Z.set(t.loading,a,!1)}};e(33948),e(57640),e(9924);var T=e(72903),_=e.n(T),E=e(53769),C=e(59564),l=e(20202),S=e.n(l),A=e(6175),N=e.n(A),L=e(62244),d=e.n(L);const w={LOAD_LOCKED:"LOAD_UNLOCKED",UNLOCK:"UNLOCK",SET_KEY:"SET_KEY",UNSET_KEY:"UNSET_KEY",LOAD_ACCOUNTS:"LOAD_ACCOUNTS",CREATE_ACCOUNT:"CREATE_ACCOUNT",IMPORT_ACCOUNTS:"IMPORT_ACCOUNTS",EXPORT_ACCOUNTS:"EXPORT_ACCOUNTS",DELETE_ACCOUNT:"DELETE_ACCOUNT",RESET_ACCOUNT:"RESET_ACCOUNT",STORE_ACCOUNT:"STORE_ACCOUNT",TRIGGER_SYNC:"TRIGGER_SYNC",TRIGGER_SYNC_UP:"TRIGGER_SYNC_UP",TRIGGER_SYNC_DOWN:"TRIGGER_SYNC_DOWN",CANCEL_SYNC:"CANCEL_SYNC",DOWNLOAD_LOGS:"DOWNLOAD_LOGS",START_LOGIN_FLOW:"START_LOGIN_FLOW",STOP_LOGIN_FLOW:"STOP_LOGIN_FLOW"},R={async[w.LOAD_LOCKED](t){let{commit:a,dispatch:e,state:s}=t;const n=await d().getSingleton();a(c.SET_LOCKED,!n.unlocked),a(c.SET_SECURED,"string"==typeof n.key||!n.unlocked)},async[w.UNLOCK](t,a){let{commit:e,dispatch:s,state:n}=t;const o=await d().getSingleton();try{await o.unlock(a)}catch(t){throw console.error(t.message),t}e(c.SET_LOCKED,!1)},async[w.SET_KEY](t,a){let{commit:e,dispatch:s,state:n}=t;const o=await d().getSingleton();await o.setKey(a)},async[w.UNSET_KEY](t){let{commit:a,dispatch:e,state:s}=t;const n=await d().getSingleton();await n.unsetKey()},async[w.LOAD_ACCOUNTS](t){let{commit:a,dispatch:e,state:s}=t;a(c.LOADING_START,"accounts");const n=await _().getAllAccounts(),o={};await Promise.all(n.map((async t=>{o[t.id]={data:t.getData(),id:t.id,label:t.getLabel(),fullPath:await S().getPathFromLocalId(t.getData().localRoot)}}))),await a(c.LOAD_ACCOUNTS,o),a(c.LOADING_END,"accounts")},async[w.CREATE_ACCOUNT](t,a){let{commit:e,dispatch:s,state:n}=t;const o=await S().getAbsoluteRootFolder(),i=await _().create({...await N().getDefaultValues(a),localRoot:o.id});return await s(w.LOAD_ACCOUNTS),i.id},async[w.IMPORT_ACCOUNTS](t,a){let{commit:e,dispatch:s,state:n}=t;await _().import(a),await s(w.LOAD_ACCOUNTS)},async[w.EXPORT_ACCOUNTS](t,a){let{commit:e,dispatch:s,state:n}=t;const o=await _().export(a),i=new Blob([JSON.stringify(o,null,"  ")],{type:"text/plain",endings:"native"});C.default.download("floccus.export.json",i)},async[w.DELETE_ACCOUNT](t,a){let{commit:e,dispatch:s,state:n}=t;const o=await _().get(a);await o.delete(),e(c.REMOVE_ACCOUNT,a)},async[w.RESET_ACCOUNT](t,a){let{commit:e,dispatch:s,state:n}=t;const o=await _().get(a);await o.storage.initCache(),await o.storage.initMappings()},async[w.STORE_ACCOUNT](t,a){let{commit:e,dispatch:s,state:n}=t,{id:o,data:i}=a;const O=await _().get(o);await O.setData(i),e(c.STORE_ACCOUNT_DATA,{id:o,data:i})},async[w.TRIGGER_SYNC](t,a){let{commit:e,dispatch:s,state:n}=t;(await d().getSingleton()).syncAccount(a)},async[w.TRIGGER_SYNC_DOWN](t,a){let{commit:e,dispatch:s,state:n}=t;const o=await d().getSingleton();await o.syncAccount(a,"slave")},async[w.TRIGGER_SYNC_UP](t,a){let{commit:e,dispatch:s,state:n}=t;const o=await d().getSingleton();await o.syncAccount(a,"overwrite")},async[w.CANCEL_SYNC](t,a){let{commit:e,dispatch:s,state:n}=t;const o=await d().getSingleton();await o.cancelSync(a,!0)},async[w.DOWNLOAD_LOGS](t){let{commit:a,dispatch:e,state:s}=t;await C.default.downloadLogs()},async[w.START_LOGIN_FLOW](t,a){let{commit:e,dispatch:s,state:n}=t;e(c.SET_LOGIN_FLOW_STATE,!0);let o=await fetch("".concat(a,"/index.php/login/v2"),{method:"POST",headers:{"User-Agent":"Floccus bookmarks sync"}});if(200!==o.status||!n.loginFlow.isRunning)throw e(c.SET_LOGIN_FLOW_STATE,!1),new Error(E.default.i18n.getMessage("LabelLoginFlowError"));let i=await o.json();try{await E.default.tabs.create({url:i.login});do{await new Promise((t=>setTimeout(t,1e3))),o=await fetch(i.poll.endpoint,{method:"POST",body:"token=".concat(i.poll.token),headers:{"Content-type":"application/x-www-form-urlencoded"}})}while(404===o.status&&n.loginFlow.isRunning);e(c.SET_LOGIN_FLOW_STATE,!1)}catch(t){throw e(c.SET_LOGIN_FLOW_STATE,!1),t}if(200!==o.status)throw new Error(E.default.i18n.getMessage("LabelLoginFlowError"));return i=await o.json(),{username:i.loginName,password:i.appPassword}},async[w.STOP_LOGIN_FLOW](t){let{commit:a}=t;a(c.SET_LOGIN_FLOW_STATE,!1)}};s.Z.use(i());var r=new n.yh({mutations:O,actions:R,state:{locked:!1,secured:!1,accounts:{},loginFlow:{isRunning:!1},loading:{accounts:!0}},getters:{}})}}]);